<!--
/**
 * CedCommerce
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the End User License Agreement (EULA)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * https://cedcommerce.com/license-agreement.txt
 *
 * @category    Ced
 * @package     Ced_Auction
 * @author 		CedCommerce Core Team <connect@cedcommerce.com>
 * @copyright   Copyright CedCommerce (https://cedcommerce.com/)
 * @license      https://cedcommerce.com/license-agreement.txt
 */
-->
<div class="page-title-wrapper">
    <h1 class="page-title">
        <span data-ui-id="page-title-wrapper" class="base">Product List</span>
    </h1>
</div>
<div class="products wrapper grid products-grid">
    <ol class="products list items product-items auction-list row">
        <?php
        $timezone = $block->getTimeZone()->getConfigTimezone();
        $auctionDetails = $block->getAuctionProduct();
        $block->updateClosedAuction();
        $enableAuction = $block->getAuctionEnable();
        if ($enableAuction && $auctionDetails) {
        foreach ($auctionDetails as $detail) {
            $block->changeStatus();
            $productId = $detail->getProductId();
            $startTime = $detail->getStartDatetime();
            $endTime = $detail->getEndDatetime();
            $url = $block->getAuctionProductUrl($productId);
			
				 $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); 
    $storeManager = $objectManager->get('Magento\Store\Model\StoreManagerInterface'); 
    $currencyCode = $storeManager->getStore()->getCurrentCurrencyCode(); 
    $currency = $objectManager->create('Magento\Directory\Model\CurrencyFactory')->create()->load($currencyCode); 
 $currencySymbol = $currency->getCurrencySymbol(); 
	
$productCollection = $objectManager->create('Magento\Catalog\Model\Product')->load($productId);
$productPriceById = $productCollection->getPrice();

			$status = $detail->getStatus();
			$reservedAmount = $detail->getStartingPrice();
			$productStartingAmount = $detail->getMaxPrice();
			$productPrice = $productPriceById;
			 $prdouctTime = $productStartingAmount - $reservedAmount;
			 $finalTime =  $prdouctTime * 100;
			$finalDate =  date("Y-m-d H:i:s", strtotime($startTime) + $finalTime);
				

            if ($url) {
                if ($detail->getStatus() == 'not started') {
                    $countDownTime = $startTime;
                    ?>

     <li class="item product product-item col-xl-3 col-lg-4 col-md-4 col-sm-6 col-6 upcoming_auction all-auctions"  data-product="<?= $productId; ?>"
             data-counter="<?= $countDownTime; ?>" data-price="<?= $productStartingAmount; ?>" data-status="<?= $status; ?>" data-finaltime="<?= $finalTime; ?>">
                        <div class="product-item-info" data-container="product-grid">

                            <a href="<?php if ($block->getAuctionProductUrl($productId)) {
                                echo $block->getAuctionProductUrl($productId);
                            } ?>"
                               class="product photo product-item-photo" tabindex="-1">
                                <?php $image = $block->getImage($block->getProduct($productId), 'category_page_list'); ?>
                                <?php if ($image) {
                                    echo $image->toHtml();
                                } ?>
                            </a>
                            <div class="product details product-item-details">
                                <input type="hidden" value="1">
                                <strong class="product name product-item-name">


                                    <a class="ced_product-item-link"
                                       href="<?php if ($block->getAuctionProductUrl($productId)) {
                                           echo $block->getAuctionProductUrl($productId);
                                       } ?>">
                                        <?php if ($detail->getProductName()) {
                                            echo $detail->getProductName();
                                        } ?>
                                    </a>
                                </strong>

                                <div class="price-box price-final_price">
                                                <span>
                                                    <span class="price-container price-final_price tax weee">
                                                        <span class="price-wrapper ">
                                                            <span class="price" style="font-size:14px;"><?= __('Retail Price:') ?></span>
															<?php $startingPrice = $this->helper('Magento\Framework\Pricing\Helper\Data')
                                        ->currency($productPriceById, true, false);
                                    if ($startingPrice) {
                                        echo $startingPrice;
                                    } ?>
                                                        </span>
                                                    </span>
                                                </span>
                                    
									<br/>
                                    <span class="price-wrapper ">
                                                            <span class="price"><?= __('Starts at:') ?></span>
                                                </span>

                                    <div id="countdown_timer" class="auction_timer">
                                        <div class="auction_timer_days"
                                             id="auction_days_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>"></div>
                                        <div class="auction_timer_hours"
                                             id="auction_hours_<?php if ($productId) echo $productId; ?>">
                                        </div>
                                        <div class="auction_timer_minutes"
                                             id="auction_minutes_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>">
                                        </div>
                                        <div class="auction_timer_seconds"
                                             id="auction_seconds_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>">
                                        </div>
                                    </div>
                                </div>

                             
								    <button class="action tocart primary"
                                        onclick="window.location.href='<?= $url ?>'"><?= __('Bid Now') ?>
                                </button>
							<?php
							
								$listBlock = $objectManager->get('\Magento\Catalog\Block\Product\ListProduct');
								$addToCartUrl =  $listBlock->getAddToCartUrl($productCollection);
								?>
								<form data-role="tocart-form" action="<?php echo $addToCartUrl; ?>" method="post">
									<?php echo $block->getBlockHtml('formkey')?>
									   <button  style="margin-top:15px;" type="submit"
											   title="Add to Cart"
											   class="action tocart primary">
											   <span>Buy Now</span>
										</button>
								 </form>
                            </div>
                        </div>
                    </li>
                    <?php
                } ?>
                    <?php
                if ($detail->getStatus() == 'processing') {
				
				$addCls ='';
					$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
					$resource = $objectManager->get('Magento\Framework\App\ResourceConnection');
					$connection = $resource->getConnection();
					$tableName = $resource->getTableName('ced_auction_biddetails');

					//Select Data from table
					$sql = "Select * FROM " . $tableName."  WHERE product_id = " . $productId;
					$results = $connection->fetchAll($sql);
					//echo "<pre>";print_r($results);
					$countStatus = array();
					foreach ($results as $key => $data)
					 {
					  if ($data['status'] == 'bidding') 
					  {
						 if ($data['product_id'] == $productId) 
						 { 
						 $addCls = "trending_auction featured_auction";						
						 }			
						}
					 }
		
		
		
                   // $countDownTime = $endTime;
					$countDownTime = $finalDate;
			
                    ?>
                   <li class="item product product-item col-xl-3 col-lg-4 col-md-4 col-sm-6 col-6 live_auction all-auctions <?php echo $addCls;?>" data-product="<?= $productId; ?>"
                        data-counter="<?= $countDownTime; ?>" data-price="<?= $productStartingAmount; ?>" data-status="<?= $status; ?>" data-finaltime="<?= $finalTime; ?>">
                        <div class="product-item-info" data-container="product-grid">

                           <a
                                    href="<?php if ($block->getAuctionProductUrl($productId)) {
                                        echo $block->getAuctionProductUrl($productId);
                                    } ?>"
                                    class="product photo product-item-photo" tabindex="-1">
                                <?php $image = $block->getImage($block->getProduct($productId), 'category_page_list'); ?>
                                <?php if ($image) {
                                    echo $image->toHtml();
                                } ?>
                            </a>
                            <div class="product details product-item-details">
                                <input type="hidden" value="1">
                                <strong class="product name product-item-name">


                                    <a class="ced_product-item-link"
                                       href="<?php if ($block->getAuctionProductUrl($productId)) {
                                           echo $block->getAuctionProductUrl($productId);
                                       } ?>">
                                        <?php if ($detail->getProductName()) {
                                            echo $detail->getProductName();
                                        } ?></a>
                                </strong>

                                <div class="price-box price-final_price">
                                  <div class="auc_price">
								  <span id="aPrice_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>" style="color: #F26C4F;
    font-size: 21px;
    font-weight: bold;
    padding: 20px 0;
    line-height: 50px;"></span>
								  </div>

                                    <span class="price-wrapper ">
                                                            <span class="price"><?php // __('Time left:') ?></span>
                                            </span>

                                    <div id="countdown_timer" class="auction_timer" style="display:none;">
									<a class="ced_product-item-link"
                                       href="<?php if ($block->getAuctionProductUrl($productId)) {
                                           echo $block->getAuctionProductUrl($productId);
                                       } ?>">
                                    
                                        <div class="auction_timer_days"
                                             id="auction_days_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>"></div>
                                        <div class="auction_timer_hours"
                                             id="auction_hours_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>"></div>
                                        <div class="auction_timer_minutes"
                                             id="auction_minutes_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>"></div>
                                        <div class="auction_timer_seconds"
                                             id="auction_seconds_<?php if ($productId) {
                                                 echo $productId;
                                             } ?>"></div>
                                    </div>
									</a>
                                </div>

                                <button class="action tocart primary"
                                        onclick="window.location.href='<?= $url ?>'"><?= __('Bid Now') ?>
                                </button>
							<?php
							
								$listBlock = $objectManager->get('\Magento\Catalog\Block\Product\ListProduct');
								$addToCartUrl =  $listBlock->getAddToCartUrl($productCollection);
								?>
								<form data-role="tocart-form" action="<?php echo $addToCartUrl; ?>" method="post">
									<?php echo $block->getBlockHtml('formkey')?>
									   <button  style="margin-top:15px;" type="submit"
											   title="Add to Cart"
											   class="action tocart primary">
											   <span>Buy Now</span>
										</button>
								 </form>
                            </div>
                        </div>
                    </li>

                    <?php
                } ?>

                    <?php
                if ($detail->getStatus() == 'closed') { ?>
                    <li class="item product product-item col-xl-3 col-lg-4 col-md-4 col-sm-6 col-6 closed_auction all-auctions" data-product="<?= $productId; ?>">
                        <div class="product-item-info" data-container="product-grid">

                            <a href="<?= $block->getAuctionProductUrl($productId) ?>"
                               class="product photo product-item-photo" tabindex="-1">
                                <?php $image = $block->getImage($block->getProduct($productId), 'category_page_list'); ?>
                                <?php if ($image) {
                                    echo $image->toHtml();
                                } ?>
                            </a>
                            <div class="product details product-item-details">
                                <input type="hidden" value="1">
                                <strong class="product name product-item-name">


                                    <a class="ced_product-item-link"
                                       href="<?php if ($block->getAuctionProductUrl($productId)) {
                                           echo $block->getAuctionProductUrl($productId);
                                       } ?>">
                                        <?php if ($detail->getProductName()) {
                                            echo $detail->getProductName();
                                        } ?></a>
                                </strong>

                                <button class="action tocart primary"><?= __('Bidding closed') ?>
                                </button>
                            </div>
                        </div>
                    </li>
                    <?php
                } ?>

                    <?php
                if ($detail->getStatus() == 'cancelled') { ?>
                    <li class="item product product-item col-xl-3 col-lg-4 col-md-4 col-sm-6 col-6 cancel_auction all-auctions" data-product="<?= $productId; ?>">
                        <div class="product-item-info" data-container="product-grid">

                            <a href="<?php if ($block->getAuctionProductUrl($productId)) {
                                echo $block->getAuctionProductUrl($productId);
                            } ?>"
                               class="product photo product-item-photo" tabindex="-1">
                                <?php $image = $block->getImage($block->getProduct($productId), 'category_page_list'); ?>
                                <?php if ($image) {
                                    echo $image->toHtml();
                                } ?>
                            </a>
                            <div class="product details product-item-details">
                                <input type="hidden" value="1">
                                <strong class="product name product-item-name">


                                    <a class="ced_product-item-link"
                                       href="<?php if ($block->getAuctionProductUrl($productId)) {
                                           echo $block->getAuctionProductUrl($productId);
                                       } ?>">
                                        <?php if ($detail->getProductName()) {
                                            echo $detail->getProductName();
                                        } ?></a>
                                </strong>

                                <button class="action tocart primary"><?= __('Bidding cancelled') ?>
                                </button>
                            </div>
                        </div>
                    </li>
                <?php
                }
            }
        } ?>

            <script>
                require(['jquery', 'jquery/ui'], function ($) {
                    $(document).ready(function () {
                        let timezone = '<?= $timezone ?>';
                        console.log('time');
                        console.log(timezone);

                        $('.product-item').each(function (index, value) {
                            console.log(index);
                            console.log(value);
                            let counter = $(this).data('counter');
                            let product = $(this).data('product');
                            let price = $(this).data('price');
                            let status = $(this).data('status');
                            let finalTime = $(this).data('finaltime');
							 if (product !== undefined && product !== null && counter !== undefined && counter !== null)
                                runTimer(counter, product, price, status, finalTime);
                        });

                        function runTimer($countDownTime, productid, price, status, finalTime) {
                            var countDownDate = new Date($countDownTime).getTime();

                            var x = setInterval(function () {
                                let currLocalTime = new Date().toLocaleString("en-US", {timeZone: timezone});
                                let currentLocalTime = new Date(currLocalTime);
                                console.log('Current ' + timezone + ' time: ' + currentLocalTime.toLocaleString());


                                let now = currentLocalTime.getTime();
									
                                var distance = countDownDate - now;
								console.log("dist is "+countDownDate);
								console.log("curent time  is "+now);
                                var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                //var productid = $productId;

                                console.log(document.getElementById("auction_days_" + productid));
                                document.getElementById("auction_days_" + productid).innerHTML = days + "d: ";
                                document.getElementById("auction_hours_" + productid).innerHTML = hours + "h: ";
                                document.getElementById("auction_minutes_" + productid).innerHTML = minutes + "m: ";
                                document.getElementById("auction_seconds_" + productid).innerHTML = seconds + "s ";
								
								
								var stattus = status;
							
							if(stattus == "processing")
							{
								var mainDif = finalTime;
								var remainDif = distance / 1000;
								var diff1 = mainDif - remainDif;
								var diff2 = diff1 / 100;
								var productPrice = price;
								var finalProductPrice = productPrice - diff2;												
								var finalProductPrice =finalProductPrice.toFixed(2);
								var currency = '<?php echo $currencySymbol;?>';
								var auc_price = currency+""+finalProductPrice;
								console.log(productPrice);
								console.log(auc_price);
								document.getElementById("aPrice_" + productid).innerHTML = auc_price ;
								
								
							}

                                if (distance < 0) {
                                    clearInterval(x);
                                    document.getElementById("auction_days_" + productid).innerHTML = 0 + "d: ";
                                    document.getElementById("auction_hours_" + productid).innerHTML = 0 + "h: ";
                                    document.getElementById("auction_minutes_" + productid).innerHTML = 0 + "m: ";
                                    document.getElementById("auction_seconds_" + productid).innerHTML = 0 + "s ";

                                    $.ajax({
                                        type: 'POST',
                                        url: "<?php echo $this->getUrl('auction/startbid/start');?>",
                                        data: {remove: true},
                                        dataType: "json",
                                        success: function (res) {
                                            window.location.reload();
                                        }
                                    });
                                }
                            }, 1000);
                        }
                    });
                });
            </script>
            <?php
        }?>
    </ol>
    <?php if (count($auctionDetails->getData()) == 0) { ?>
        <div><p>Sorry, no auction products are available.</p></div>
    <?php } ?>
</div>


<?php if ($block->getPagerHtml()) { ?>
    <div class="order-products-toolbar toolbar bottom"><?php echo $block->getPagerHtml(); ?></div>
    <?php
} ?>


